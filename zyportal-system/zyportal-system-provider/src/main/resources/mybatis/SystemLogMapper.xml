<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zkzy.zyportal.system.provider.mapper.SystemLogMapper" >
  <resultMap id="BaseResultMap" type="com.zkzy.zyportal.system.api.entity.SystemLog" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 10 13:19:14 CST 2017.
    -->
    <id column="ID" property="id" jdbcType="VARCHAR" />
    <result column="IP" property="ip" jdbcType="VARCHAR" />
    <result column="LOCATION" property="location" jdbcType="VARCHAR" />
    <result column="USERAGENT" property="useragent" jdbcType="VARCHAR" />
    <result column="USERNAME" property="username" jdbcType="VARCHAR" />
    <result column="URI" property="uri" jdbcType="VARCHAR" />
    <result column="PERMISSION" property="permission" jdbcType="VARCHAR" />
    <result column="TIME" property="time" jdbcType="VARCHAR" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 10 13:19:14 CST 2017.
    -->
    delete from SYSTEM_LOG
    where ID = #{id,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.zkzy.zyportal.system.api.entity.SystemLog" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 10 13:19:14 CST 2017.
    -->
    insert into SYSTEM_LOG (ID, IP, LOCATION, 
      USERAGENT, USERNAME, URI, 
      PERMISSION, TIME)
    values (sys_guid(), #{ip,jdbcType=VARCHAR}, #{location,jdbcType=VARCHAR},
      #{useragent,jdbcType=VARCHAR}, #{username,jdbcType=VARCHAR}, #{uri,jdbcType=VARCHAR}, 
      #{permission,jdbcType=VARCHAR}, #{time,jdbcType=VARCHAR})
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.zkzy.zyportal.system.api.entity.SystemLog" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 10 13:19:14 CST 2017.
    -->
    update SYSTEM_LOG
    set IP = #{ip,jdbcType=VARCHAR},
      LOCATION = #{location,jdbcType=VARCHAR},
      USERAGENT = #{useragent,jdbcType=VARCHAR},
      USERNAME = #{username,jdbcType=VARCHAR},
      URI = #{uri,jdbcType=VARCHAR},
      PERMISSION = #{permission,jdbcType=VARCHAR},
      TIME = #{time,jdbcType=VARCHAR}
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 10 13:19:14 CST 2017.
    -->
    select ID, IP, LOCATION, USERAGENT, USERNAME, URI, PERMISSION, TIME
    from SYSTEM_LOG
    where ID = #{id,jdbcType=VARCHAR}
  </select>
  <select id="selectAll" resultMap="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 10 13:19:14 CST 2017.
    -->
    select ID, IP, LOCATION, USERAGENT, USERNAME, URI, PERMISSION, TIME
    from SYSTEM_LOG
  </select>


  <resultMap id="logPolyline" type="com.zkzy.zyportal.system.api.viewModel.LogPolyline" >
    <result column="count" property="count" jdbcType="VARCHAR" />
    <result column="time" property="time" jdbcType="VARCHAR" />
  </resultMap>

  <resultMap id="logCount" type="com.zkzy.zyportal.system.api.viewModel.LogCount" >
    <result column="count" property="count" jdbcType="VARCHAR" />
    <result column="permission" property="permission" jdbcType="VARCHAR" />
    <result column="permissionname" property="permissionname" jdbcType="VARCHAR" />
    <result column="time" property="time" jdbcType="VARCHAR" />
    <result column="uri" property="uri" jdbcType="VARCHAR" />
  </resultMap>

  <resultMap id="logTop" type="com.zkzy.zyportal.system.api.viewModel.LogTop" >
    <result column="PERMISSION" property="permission" jdbcType="VARCHAR" />
    <result column="COUNT" property="count" jdbcType="VARCHAR" />
    <result column="URL" property="url" jdbcType="VARCHAR" />
    <result column="NAME" property="name" jdbcType="VARCHAR" />
    <result column="STATUS" property="status" jdbcType="VARCHAR" />
  </resultMap>

  <select id="queryMenuTop" resultMap="logTop">
    select *from (select t1.*,t2.URL,t2.NAME,t2.STATUS from (select PERMISSION,count(*) as count from SYSTEM_LOG
    where PERMISSION is not null ${_parameter}
    group by PERMISSION order by count desc) t1,SYSTEM_MENU t2
    where t1.PERMISSION=t2.PERMISSION  order by count desc) where rownum &lt;=10 order by count desc
  </select>

  <select id="queryMenuTopOther" resultType="int">
    select count(*)from SYSTEM_LOG where PERMISSION is not null ${_parameter}
  </select>

  <select id="queryLogGroupByDate" resultMap="logPolyline" parameterType="com.zkzy.zyportal.system.api.viewModel.LogPolyline" >
    select SUBSTR(TIME,0,10) as time,count(*) as count from SYSTEM_LOG where PERMISSION=#{permission,jdbcType=VARCHAR} and TIME BETWEEN #{startDate,jdbcType=VARCHAR} and #{endDate,jdbcType=VARCHAR} group by SUBSTR(TIME,0,10) order by TIME
  </select>

  <select id="queryUserLoginLog" resultMap="logPolyline" parameterType="com.zkzy.zyportal.system.api.viewModel.UserLoginLog">
SELECT
	SUBSTR (TIME, 0, 10) AS TIME,
	COUNT (*) AS COUNT
FROM
	SYSTEM_LOG
WHERE
	1 = 1
AND URI = #{uri,jdbcType=VARCHAR}
AND TIME BETWEEN #{startDate,jdbcType=VARCHAR} and #{endDate,jdbcType=VARCHAR}
    <if test="username!=null" >
    and USERNAME=#{username,jdbcType=VARCHAR}
    </if>
    GROUP BY
	SUBSTR (TIME, 0, 10)
ORDER BY
	TIME
  </select>

  <select id="queryAllLogGroupByPermission" resultMap="logPolyline">
    select NAME as menuName,PERMISSION as permission from (select a.PERMISSION,b.NAME from SYSTEM_LOG a,SYSTEM_MENU b where a.PERMISSION is not null and a.PERMISSION=b.PERMISSION) group by NAME,PERMISSION
  </select>

  <select id="queryLogCount" resultMap="logCount">
    SELECT a.count,a.PERMISSION,b.NAME AS PERMISSIONNAME FROM(
      select count(PERMISSION) as count,PERMISSION FROM(
        select PERMISSION from SYSTEM_LOG WHERE PERMISSION IS NOT NULL
          ${_parameter}
      ) GROUP BY PERMISSION
    ) a LEFT JOIN SYSTEM_MENU b ON a.PERMISSION=b.PERMISSION
    ORDER BY count DESC
  </select>

  <select id="selectPermissionCount" resultType="java.lang.String" >
    select count(ID) as count from SYSTEM_LOG
    where 1=1
    ${_parameter}
  </select>

  <select id="selectPermissionCountDateGroup" resultMap="logCount" >
    SELECT count(a.ID) AS count,a.PERMISSION,b.NAME as PERMISSIONNAME,a.URI,SUBSTR(a.TIME,0,10) AS time
    FROM SYSTEM_LOG a
    LEFT JOIN SYSTEM_MENU b
    ON a.PERMISSION=b.PERMISSION
    HAVING 1=1 ${_parameter}
    GROUP BY a.PERMISSION,b.NAME,a.USERNAME,a.URI,SUBSTR(a.TIME,0,10)
    ORDER BY SUBSTR(a.TIME,0,10) ASC
  </select>

</mapper>